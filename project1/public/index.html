<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Search Automation Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      body {
        background: #f3f6fb;
        color: #1f2a44;
      }
      header {
        background: #ffffff;
        border-bottom: 1px solid #e0e6f1;
      }
      .card {
        border: 1px solid #e3eaf6;
        border-radius: 1rem;
        box-shadow: 0 20px 45px rgba(31, 42, 68, 0.05);
      }
      .status {
        font-size: 0.95rem;
      }
      .table-responsive {
        border-radius: 0.75rem;
        border: 1px solid #e3eaf6;
      }
    </style>
  </head>
  <body>
    <header class="py-4 shadow-sm">
      <div class="container">
        <h1 class="h3 mb-1">Job Search Automation Dashboard</h1>
        <p class="text-muted mb-0">
          Run the Puppeteer-powered Google Jobs scrape and visualize the structured output.
        </p>
      </div>
    </header>
    <main class="container py-4">
      <div class="row g-4">
        <section class="col-12">
          <div class="card h-100">
            <div class="card-body">
              <form id="searchForm" class="row g-3">
                <div class="col-12">
                  <label for="query" class="form-label fw-semibold">Job search query</label>
                  <input
                    type="text"
                    class="form-control form-control-lg"
                    id="query"
                    name="query"
                    placeholder="e.g. Software Engineer vacancies in Sri Lanka"
                    value="Software Engineer vacancies in Sri Lanka"
                    required
                  />
                </div>
                <div class="col-12 col-md-auto">
                  <button type="submit" id="runButton" class="btn btn-dark btn-lg w-100">
                    Run search
                  </button>
                </div>
                <div class="col-12">
                  <div class="status text-muted" id="status">Ready.</div>
                </div>
              </form>
            </div>
          </div>
        </section>
        <section class="col-12" id="resultsPanel">
          <div class="card">
            <div class="card-body">
              <div id="placeholder" class="text-muted">
                Trigger a run to see live results. Output data from the automation will appear here.
              </div>
              <div id="results"></div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script>
      const form = document.getElementById('searchForm');
      const resultsContainer = document.getElementById('results');
      const placeholder = document.getElementById('placeholder');
      const statusEl = document.getElementById('status');
      const runButton = document.getElementById('runButton');

      const formatDateTime = (value) => {
        if (!value) return '—';
        return new Date(value).toLocaleString();
      };

      const createList = (items, label) => {
        if (!items?.length) return `<p class="muted">No ${label} detected.</p>`;
        return `
          <div class="chips">
            ${items
              .map(
                (item) =>
                  `<span class="chip">
                    ${typeof item === 'string' ? item : item.name || item.title || 'Unnamed'}
                  </span>`
              )
              .join('')}
          </div>`;
      };

      const sanitize = (value) => {
        if (value === undefined || value === null) return '';
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      };

      const renderJobsTable = (jobs = []) => {
        if (!jobs.length) {
          return '<p class="muted">No job entries parsed from the results.</p>';
        }
        return `
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light text-uppercase small">
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Title</th>
                  <th scope="col">Company</th>
                  <th scope="col">Location</th>
                  <th scope="col">Job Link</th>
                  <th scope="col">Google Search</th>
                </tr>
              </thead>
              <tbody>
                ${jobs
                  .map(
                    (job, idx) => `
                      <tr>
                        <th scope="row">${idx + 1}</th>
                        <td class="fw-semibold">${sanitize(job.title) || '—'}</td>
                        <td>${sanitize(job.company) || '—'}</td>
                        <td>${sanitize(job.location) || '—'}</td>
                        <td>${
                          job.link
                            ? `<a class="link-primary" href="${job.link}" target="_blank" rel="noopener">Open</a>`
                            : '—'
                        }</td>
                        <td>${
                          job.searchResult
                            ? `<a class="link-secondary" href="${job.searchResult}" target="_blank" rel="noopener" title="${sanitize(job.searchResult)}">Google result</a>`
                            : '—'
                        }</td>
                      </tr>
                    `
                  )
                  .join('')}
              </tbody>
            </table>
          </div>
        `;
      };

      const renderDetailCards = (items = [], title = 'Details') => {
        if (!items.length) {
          return '<p class="muted">No detail cards collected.</p>';
        }
        return `
          <div class="card-grid">
            ${items
              .map(
                (item) => `
                  <article class="card">
                    <h3>${sanitize(item.title) || 'Untitled job'}</h3>
                    <p><strong>Company:</strong> ${sanitize(item.company) || '—'}</p>
                    <p><strong>Location:</strong> ${sanitize(item.location) || '—'}</p>
                    <p><strong>Description:</strong> ${sanitize(item.description) || '—'}</p>
                    ${
                      item.url
                        ? `<p><a href="${item.url}" target="_blank" rel="noopener">Open posting</a></p>`
                        : ''
                    }
                    ${
                      item.content
                        ? `<details>
                            <summary>Full text</summary>
                            <pre>${sanitize(item.content)}</pre>
                          </details>`
                        : ''
                    }
                  </article>
                `
              )
              .join('')}
          </div>
        `;
      };

      const renderReport = (report) => {
        placeholder.hidden = true;
        resultsContainer.innerHTML = `
          <section>
            <h2 class="section-title">Parsed job list</h2>
            ${renderJobsTable(report.jobs || [])}
          </section>
        `;
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const query = form.query.value.trim();

        if (!query) {
          statusEl.textContent = 'Please enter a query.';
          statusEl.className = 'status error';
          return;
        }

        runButton.disabled = true;
        statusEl.textContent = 'Launching Chrome and fetching jobs...';
        statusEl.className = 'status';
        placeholder.hidden = false;
        placeholder.innerHTML = `
          <div class="loader-row">
            <div class="loader" role="status" aria-label="Loading"></div>
            <span>Automation in progress...</span>
          </div>
        `;
        resultsContainer.innerHTML = '';

        try {
          const response = await fetch('/api/jobs/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
          });

          if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
          }
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error || 'Unknown API error');
          }
          statusEl.textContent = 'Automation finished successfully.';
          statusEl.className = 'status success';
          renderReport(result.data);
        } catch (error) {
          console.error(error);
          statusEl.textContent = `Run failed: ${error.message}`;
          statusEl.className = 'status error';
          placeholder.hidden = false;
          placeholder.textContent = 'Unable to load results. Check the server logs.';
        } finally {
          runButton.disabled = false;
        }
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>

